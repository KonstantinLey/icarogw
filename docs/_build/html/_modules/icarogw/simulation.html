<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>icarogw.simulation &mdash; icarogw 2.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            icarogw
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">icarogw</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">icarogw</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">icarogw.simulation</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for icarogw.simulation</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">.cupy_pal</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.cosmology</span> <span class="kn">import</span> <span class="n">astropycosmology</span>
<span class="kn">from</span> <span class="nn">.wrappers</span> <span class="kn">import</span> <span class="n">massprior_PowerLawPeak</span>
<span class="kn">from</span> <span class="nn">.wrappers</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">interpolate</span>
<span class="kn">from</span> <span class="nn">astropy.cosmology</span> <span class="kn">import</span> <span class="n">Planck15</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span> <span class="k">as</span> <span class="n">_tqdm</span>

<div class="viewcode-block" id="chirp_mass_det"><a class="viewcode-back" href="../../icarogw.html#icarogw.simulation.chirp_mass_det">[docs]</a><span class="k">def</span> <span class="nf">chirp_mass_det</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">,</span><span class="n">z</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Fonction qui calcule la chirp mass d&#39;un systeme binaire à partir de m1 et m2 (en Msol) </span>
<span class="sd">    dans le detector frame. (facteur m_d = (1+z)*m_s)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">m1</span><span class="o">*</span><span class="n">m2</span><span class="p">,</span><span class="mi">3</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">m1</span><span class="o">+</span><span class="n">m2</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">5</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">z</span><span class="p">)</span></div>

<div class="viewcode-block" id="chirp_mass"><a class="viewcode-back" href="../../icarogw.html#icarogw.simulation.chirp_mass">[docs]</a><span class="k">def</span> <span class="nf">chirp_mass</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Fonction qui calcule la chirp mass d&#39;un systeme binaire à partir de m1 et m2 (en Msol)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">m1</span><span class="o">*</span><span class="n">m2</span><span class="p">,</span><span class="mi">3</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">m1</span><span class="o">+</span><span class="n">m2</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span></div>

<div class="viewcode-block" id="mass_ratio"><a class="viewcode-back" href="../../icarogw.html#icarogw.simulation.mass_ratio">[docs]</a><span class="k">def</span> <span class="nf">mass_ratio</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Computes the mass ratio (convention used is m1&gt;m2 et q &lt;1)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">m2</span><span class="o">/</span><span class="n">m1</span></div>

<div class="viewcode-block" id="f_GW"><a class="viewcode-back" href="../../icarogw.html#icarogw.simulation.f_GW">[docs]</a><span class="k">def</span> <span class="nf">f_GW</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">,</span><span class="n">z</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    f_GW in detector frame in Hz</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">m1</span> <span class="o">=</span> <span class="n">m1</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">z</span><span class="p">)</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">m2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">z</span><span class="p">)</span>
    <span class="n">M</span><span class="o">=</span><span class="n">m1</span><span class="o">+</span><span class="n">m2</span>
    <span class="n">f_ISCO</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.20</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">M</span><span class="p">))</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">3</span>
    <span class="n">to_ret</span> <span class="o">=</span> <span class="n">f_ISCO</span><span class="o">*</span><span class="mi">2</span>
    
    <span class="k">return</span> <span class="n">to_ret</span></div>

<div class="viewcode-block" id="z_to_dl"><a class="viewcode-back" href="../../icarogw.html#icarogw.simulation.z_to_dl">[docs]</a><span class="k">def</span> <span class="nf">z_to_dl</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Convert a redshift value into a luminosity distance value.</span>
<span class="sd">    The Planck15 cosmology is used here. (but can be changed)</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    ----------</span>
<span class="sd">    z : float or array</span>
<span class="sd">        redshift to be converted</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">cosmo</span> <span class="o">=</span> <span class="n">astropycosmology</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">cosmo</span><span class="o">.</span><span class="n">build_cosmology</span><span class="p">(</span><span class="n">Planck15</span><span class="p">)</span>
    <span class="n">to_ret</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">z2dl</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">to_ret</span></div>

<div class="viewcode-block" id="dl_to_z"><a class="viewcode-back" href="../../icarogw.html#icarogw.simulation.dl_to_z">[docs]</a><span class="k">def</span> <span class="nf">dl_to_z</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Convert a dL value into a redshift value.</span>
<span class="sd">    The Planck15 cosmology is used here. (but can be changed)</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    ----------</span>
<span class="sd">    dL : float or array</span>
<span class="sd">        dL to be converted</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">cosmo</span> <span class="o">=</span> <span class="n">astropycosmology</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">cosmo</span><span class="o">.</span><span class="n">build_cosmology</span><span class="p">(</span><span class="n">Planck15</span><span class="p">)</span>
    <span class="n">to_ret</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">dl2z</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">to_ret</span></div>

<div class="viewcode-block" id="dVc_dz"><a class="viewcode-back" href="../../icarogw.html#icarogw.simulation.dVc_dz">[docs]</a><span class="k">def</span> <span class="nf">dVc_dz</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Compute the differential comoving volume as function of z</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">cosmo</span> <span class="o">=</span> <span class="n">astropycosmology</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">cosmo</span><span class="o">.</span><span class="n">build_cosmology</span><span class="p">(</span><span class="n">Planck15</span><span class="p">)</span>
    
    <span class="c1"># differential of comov volume in Gpc3</span>
    <span class="n">to_ret</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">dVc_by_dzdOmega_at_z</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>  
    
    <span class="k">return</span> <span class="n">to_ret</span></div>


<div class="viewcode-block" id="rvs_theta"><a class="viewcode-back" href="../../icarogw.html#icarogw.simulation.rvs_theta">[docs]</a><span class="k">def</span> <span class="nf">rvs_theta</span><span class="p">(</span><span class="n">Nsamp</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generate samples according to the CDF of theta in the range [a,b] with a&lt;b</span>
<span class="sd">    By default, the full range is [0,1.4]</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">cdf_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s2">&quot;/Users/pierra/Desktop/These_ip2i/Cosmology_researches/icaroGW/icarogw_2/Sub_pop_BBH_ananalysis/data/Pw_three.dat&quot;</span><span class="p">)</span>
    <span class="n">cdf_theta</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span><span class="n">cdf_theta</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">cdf_theta</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> 
    <span class="n">cdf_theta_func</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">cdf_theta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">cdf_theta</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> 
    <span class="n">inv_cdf_theta_func</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">cdf_theta</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">cdf_theta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> 
    
    
    <span class="n">unif_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">Nsamp</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">cdf_theta_func</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">-</span><span class="n">cdf_theta_func</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="o">+</span> <span class="n">cdf_theta_func</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">inv_cdf_theta_func</span><span class="p">(</span><span class="n">unif_samples</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">theta</span></div>

<div class="viewcode-block" id="dVc_dz_reweight"><a class="viewcode-back" href="../../icarogw.html#icarogw.simulation.dVc_dz_reweight">[docs]</a><span class="k">def</span> <span class="nf">dVc_dz_reweight</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">,</span><span class="n">z</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Perform an importance sampling with a weight (dVc/dz)*(1/1+z)</span>
<span class="sd">    Returns the reweighted quantities</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">dVc_dz</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">z</span><span class="p">)</span>
    <span class="n">idx_resampling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">weight</span><span class="p">),</span><span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">m1</span><span class="p">),</span><span class="n">p</span><span class="o">=</span><span class="n">weight</span><span class="o">/</span><span class="n">weight</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">m1</span> <span class="o">=</span> <span class="n">m1</span><span class="p">[</span><span class="n">idx_resampling</span><span class="p">]</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">m2</span><span class="p">[</span><span class="n">idx_resampling</span><span class="p">]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">idx_resampling</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">z</span></div>


<div class="viewcode-block" id="snr_samples"><a class="viewcode-back" href="../../icarogw.html#icarogw.simulation.snr_samples">[docs]</a><span class="k">def</span> <span class="nf">snr_samples</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">numdet</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">rho_s</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">dL_s</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">Md_s</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span><span class="n">theta</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Fonction that computes the SNR (approximation), using the formula showed in &quot;Cosmo in the dark appendix&quot;</span>
<span class="sd">    </span>
<span class="sd">    From m1s, m2s and z</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    ----------</span>
<span class="sd">    rho_s : float</span>
<span class="sd">         Reference value of the SNR </span>
<span class="sd">    dL_s : float</span>
<span class="sd">        Reference value of the luminosity distance in [Gpc]</span>
<span class="sd">    Md_s : float</span>
<span class="sd">        Reference value for the chirp mass in [Msol]</span>
<span class="sd">    Md : float or array</span>
<span class="sd">        Chirp mass in the detector frame</span>
<span class="sd">    dL: float or array  </span>
<span class="sd">        Luminosity distance </span>
<span class="sd">    theta : float or array</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">Md</span> <span class="o">=</span> <span class="n">chirp_mass_det</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
    <span class="n">dL</span> <span class="o">=</span> <span class="n">z_to_dl</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">theta</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> 
        <span class="n">theta</span> <span class="o">=</span> <span class="n">rvs_theta</span><span class="p">(</span><span class="n">Nsamp</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">m1</span><span class="p">),</span><span class="n">a</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="mf">1.4</span><span class="p">)</span>
        <span class="n">rand_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">m1</span><span class="p">))</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">rand_theta</span>
    
    <span class="n">rho_true</span> <span class="o">=</span> <span class="n">rho_s</span><span class="o">*</span><span class="n">theta</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">Md</span><span class="o">/</span><span class="n">Md_s</span><span class="p">,</span><span class="mi">5</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">dL_s</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span><span class="o">/</span><span class="n">dL</span><span class="p">)</span>
    <span class="n">rho_det_squarred</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ncx2</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">numdet</span><span class="p">,</span><span class="n">rho_true</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">rho_true</span><span class="p">))</span>
    <span class="n">rho_det</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">rho_det_squarred</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">rho_true</span> <span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">rho_det</span>    </div>

<div class="viewcode-block" id="chirp_mass_noise"><a class="viewcode-back" href="../../icarogw.html#icarogw.simulation.chirp_mass_noise">[docs]</a><span class="k">def</span> <span class="nf">chirp_mass_noise</span><span class="p">(</span><span class="n">Md</span><span class="p">,</span><span class="n">rho_obs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Return the dected values of the chirp mass.</span>
<span class="sd">    Likelihood model based on Annexe B : https://arxiv.org/pdf/2103.14663.pdf</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">Md_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rho_obs</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="n">Md</span><span class="o">*</span><span class="mi">10</span><span class="o">/</span><span class="n">rho_obs</span> <span class="o">+</span> <span class="n">Md</span>
    <span class="k">return</span> <span class="n">Md_obs</span> </div>

<div class="viewcode-block" id="mass_ratio_noise"><a class="viewcode-back" href="../../icarogw.html#icarogw.simulation.mass_ratio_noise">[docs]</a><span class="k">def</span> <span class="nf">mass_ratio_noise</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">rho_obs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Return the dected values of the mass ratio.</span>
<span class="sd">    Likelihood model based on Annexe B : https://arxiv.org/pdf/2103.14663.pdf</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">q_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rho_obs</span><span class="p">))</span><span class="o">*</span><span class="mf">0.25</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="mi">10</span><span class="o">/</span><span class="n">rho_obs</span> <span class="o">+</span> <span class="n">q</span>
    <span class="k">return</span> <span class="n">q_obs</span></div>

<div class="viewcode-block" id="theta_noise"><a class="viewcode-back" href="../../icarogw.html#icarogw.simulation.theta_noise">[docs]</a><span class="k">def</span> <span class="nf">theta_noise</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">rho_obs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Return the dected values of theta.</span>
<span class="sd">    Likelihood model based on Annexe B : https://arxiv.org/pdf/2103.14663.pdf</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">theta_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rho_obs</span><span class="p">))</span><span class="o">*</span><span class="mf">0.3</span><span class="o">*</span><span class="mi">10</span><span class="o">/</span><span class="n">rho_obs</span> <span class="o">+</span> <span class="n">theta</span>
    <span class="k">return</span> <span class="n">theta_obs</span></div>

<div class="viewcode-block" id="noise"><a class="viewcode-back" href="../../icarogw.html#icarogw.simulation.noise">[docs]</a><span class="k">def</span> <span class="nf">noise</span><span class="p">(</span><span class="n">Md</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">rho_obs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Use the 3 functions above to compute the 3 detected values for Md, q and theta</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">Md_obs</span> <span class="o">=</span> <span class="n">chirp_mass_noise</span><span class="p">(</span><span class="n">Md</span><span class="p">,</span><span class="n">rho_obs</span><span class="p">)</span>
    <span class="n">q_obs</span> <span class="o">=</span> <span class="n">mass_ratio_noise</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">rho_obs</span><span class="p">)</span>
    <span class="n">theta_obs</span> <span class="o">=</span> <span class="n">theta_noise</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">rho_obs</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">Md_obs</span><span class="p">,</span> <span class="n">q_obs</span><span class="p">,</span> <span class="n">theta_obs</span></div>


<div class="viewcode-block" id="snr_and_freq_cut"><a class="viewcode-back" href="../../icarogw.html#icarogw.simulation.snr_and_freq_cut">[docs]</a><span class="k">def</span> <span class="nf">snr_and_freq_cut</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">snr</span><span class="p">,</span><span class="n">snrthr</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span><span class="n">fgw_cut</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Apply a cut in snr : snr &gt; snrthr</span>
<span class="sd">    Apply a cut in frequency of the GWs in det frame : fGW &gt; fgw_cut</span>
<span class="sd">    Returns the indices of each event that fits the two criterion</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">freq_GW_astro</span> <span class="o">=</span> <span class="n">f_GW</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">snr</span><span class="o">&gt;=</span><span class="n">snrthr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">freq_GW_astro</span><span class="o">&gt;</span><span class="n">fgw_cut</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">indices</span></div>

<div class="viewcode-block" id="likelihood_evaluation"><a class="viewcode-back" href="../../icarogw.html#icarogw.simulation.likelihood_evaluation">[docs]</a><span class="k">def</span> <span class="nf">likelihood_evaluation</span><span class="p">(</span><span class="n">rhos</span><span class="p">,</span><span class="n">qs</span><span class="p">,</span><span class="n">Mds</span><span class="p">,</span><span class="n">thetas</span><span class="p">,</span><span class="n">rho_obs</span><span class="p">,</span><span class="n">q_obs</span><span class="p">,</span><span class="n">Md_obs</span><span class="p">,</span><span class="n">theta_obs</span><span class="p">,</span><span class="n">numdet</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Compute the total likelihood of : the snr, the chirp mass, the mass ratio and theta</span>
<span class="sd">    All variables with an &#39;s&#39; at the end are the one we evaluate the likelihood at according to the &#39;_obs&#39; one.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">likelihood_tot</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ncx2</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">rho_obs</span><span class="o">**</span><span class="mf">2.</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">numdet</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">rhos</span><span class="p">,</span><span class="mf">2.</span><span class="p">))</span>\
        <span class="o">*</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">q_obs</span><span class="p">,</span> <span class="n">qs</span><span class="p">,</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">qs</span><span class="o">*</span><span class="mi">10</span><span class="o">/</span><span class="n">rho_obs</span><span class="p">)</span>\
        <span class="o">*</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">Md_obs</span><span class="p">,</span> <span class="n">Mds</span><span class="p">,</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">Mds</span><span class="o">*</span><span class="mi">10</span><span class="o">/</span><span class="n">rho_obs</span><span class="p">)</span>\
        <span class="o">*</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">theta_obs</span><span class="p">,</span> <span class="n">thetas</span><span class="p">,</span> <span class="mf">0.3</span><span class="o">*</span><span class="mi">10</span><span class="o">/</span><span class="n">rho_obs</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">likelihood_tot</span></div>

<div class="viewcode-block" id="generate_mass_inj"><a class="viewcode-back" href="../../icarogw.html#icarogw.simulation.generate_mass_inj">[docs]</a><span class="k">def</span> <span class="nf">generate_mass_inj</span><span class="p">(</span><span class="n">Nsamp</span><span class="p">,</span><span class="n">mass_model</span><span class="p">,</span><span class="n">dic_param</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generate Samples of m1s and m2s the chosen mass_model and compute the prior associated in </span>
<span class="sd">    the source frame!</span>
<span class="sd">    Models available : PowerLaw, PowerLawPeak, MultiPeak</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Nsamp : integer</span>
<span class="sd">        The number of samples for m1s and m2s you want</span>
<span class="sd">    mass_model : str</span>
<span class="sd">        The name of the mass model desired</span>
<span class="sd">    dic_param : dict</span>
<span class="sd">        Dictionnary with the param needed for the model inside</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="n">mass_model</span> <span class="o">==</span><span class="s1">&#39;PowerLaw&#39;</span><span class="p">:</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="n">massprior_PowerLaw</span><span class="p">()</span>
        <span class="n">mp</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">dic_param</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span><span class="n">beta</span><span class="o">=</span><span class="n">dic_param</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">],</span><span class="n">mmin</span><span class="o">=</span><span class="n">dic_param</span><span class="p">[</span><span class="s1">&#39;mmin&#39;</span><span class="p">],</span><span class="n">mmax</span><span class="o">=</span><span class="n">dic_param</span><span class="p">[</span><span class="s1">&#39;mmax&#39;</span><span class="p">])</span>
        
    <span class="k">elif</span> <span class="n">mass_model</span> <span class="o">==</span><span class="s1">&#39;PowerLawPeak&#39;</span><span class="p">:</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="n">massprior_PowerLawPeak</span><span class="p">()</span>
        <span class="n">mp</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">dic_param</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span><span class="n">beta</span><span class="o">=</span><span class="n">dic_param</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">],</span><span class="n">mmin</span><span class="o">=</span><span class="n">dic_param</span><span class="p">[</span><span class="s1">&#39;mmin&#39;</span><span class="p">],</span><span class="n">mmax</span><span class="o">=</span><span class="n">dic_param</span><span class="p">[</span><span class="s1">&#39;mmax&#39;</span><span class="p">],</span><span class="n">delta_m</span><span class="o">=</span><span class="n">dic_param</span><span class="p">[</span><span class="s1">&#39;delta_m&#39;</span><span class="p">],</span>
        <span class="n">mu_g</span><span class="o">=</span><span class="n">dic_param</span><span class="p">[</span><span class="s1">&#39;mu_g&#39;</span><span class="p">],</span><span class="n">sigma_g</span><span class="o">=</span><span class="n">dic_param</span><span class="p">[</span><span class="s1">&#39;sigma_g&#39;</span><span class="p">],</span><span class="n">lambda_peak</span><span class="o">=</span><span class="n">dic_param</span><span class="p">[</span><span class="s1">&#39;lambda_peak&#39;</span><span class="p">])</span>

    <span class="k">elif</span> <span class="n">mass_model</span> <span class="o">==</span><span class="s1">&#39;MultiPeak&#39;</span><span class="p">:</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="n">massprior_MultiPeak</span><span class="p">()</span>
        <span class="n">mp</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">dic_param</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span><span class="n">beta</span><span class="o">=</span><span class="n">dic_param</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">],</span><span class="n">mmin</span><span class="o">=</span><span class="n">dic_param</span><span class="p">[</span><span class="s1">&#39;mmin&#39;</span><span class="p">],</span><span class="n">mmax</span><span class="o">=</span><span class="n">dic_param</span><span class="p">[</span><span class="s1">&#39;mmax&#39;</span><span class="p">],</span><span class="n">delta_m</span><span class="o">=</span><span class="n">dic_param</span><span class="p">[</span><span class="s1">&#39;delta_m&#39;</span><span class="p">],</span>
        <span class="n">mu_g_low</span><span class="o">=</span><span class="n">dic_param</span><span class="p">[</span><span class="s1">&#39;mu_g_low&#39;</span><span class="p">],</span><span class="n">sigma_g_low</span><span class="o">=</span><span class="n">dic_param</span><span class="p">[</span><span class="s1">&#39;sigma_g_low&#39;</span><span class="p">],</span><span class="n">lambda_g_low</span><span class="o">=</span><span class="n">dic_param</span><span class="p">[</span><span class="s1">&#39;lambda_g_low&#39;</span><span class="p">],</span>
        <span class="n">mu_g_high</span><span class="o">=</span><span class="n">dic_param</span><span class="p">[</span><span class="s1">&#39;mu_g_high&#39;</span><span class="p">],</span><span class="n">sigma_g_high</span><span class="o">=</span><span class="n">dic_param</span><span class="p">[</span><span class="s1">&#39;sigma_g_high&#39;</span><span class="p">],</span><span class="n">lambda_g</span><span class="o">=</span><span class="n">dic_param</span><span class="p">[</span><span class="s1">&#39;lambda_g&#39;</span><span class="p">])</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The model you chose is not available! </span><span class="se">\n</span><span class="s1"> Choose in the following list : PowerLaw, PowerLawPeak, MultiPeak &#39;</span><span class="p">)</span>
        
    <span class="n">m1</span><span class="p">,</span><span class="n">m2</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">Nsamp</span><span class="p">)</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">pdf</span></div>

<div class="viewcode-block" id="generate_dL_inj"><a class="viewcode-back" href="../../icarogw.html#icarogw.simulation.generate_dL_inj">[docs]</a><span class="k">def</span> <span class="nf">generate_dL_inj</span><span class="p">(</span><span class="n">Nsamp</span><span class="p">,</span><span class="n">zmax</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generate Samples of dL propto a PL distribution (\prpto dL^2)</span>
<span class="sd">    The PL is defined in the interval [a,b]</span>
<span class="sd">    p(dL) \propto a*dL^(a-1) , with (a-1) =2</span>
<span class="sd">    &#39;&#39;&#39;</span>   

    <span class="n">beta</span> <span class="o">=</span> <span class="n">z_to_dl</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">zmax</span><span class="p">))</span>
    <span class="n">dL_sample</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">powerlaw</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="n">beta</span><span class="o">-</span><span class="mf">10.</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">Nsamp</span><span class="p">)</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">powerlaw</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">dL_sample</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">beta</span><span class="o">-</span><span class="mf">10.</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">dL_sample</span><span class="p">,</span> <span class="n">pdf</span></div>

<div class="viewcode-block" id="snr_samples_det"><a class="viewcode-back" href="../../icarogw.html#icarogw.simulation.snr_samples_det">[docs]</a><span class="k">def</span> <span class="nf">snr_samples_det</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">,</span><span class="n">dL</span><span class="p">,</span><span class="n">numdet</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">rho_s</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">dL_s</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">Md_s</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span><span class="n">theta</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Fonction that computes the SNR (approximation), using the formula showed in &quot;Cosmo in the dark appendix&quot;</span>
<span class="sd">    From m1d, m2d and dL</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    ----------</span>
<span class="sd">    rho_s : float</span>
<span class="sd">        Reference value of the SNR </span>
<span class="sd">    dL_s : float</span>
<span class="sd">        Reference value of the luminosity distance in [Gpc]</span>
<span class="sd">    Md_s : float</span>
<span class="sd">        Reference value for the chirp mass in [Msol]</span>
<span class="sd">    Md : float or array</span>
<span class="sd">        Chirp mass in the detector frame</span>
<span class="sd">    dL: float or array  </span>
<span class="sd">        Luminosity distance </span>
<span class="sd">    theta : float or array</span>
<span class="sd">        Projection factor</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">Md</span> <span class="o">=</span> <span class="n">chirp_mass</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">)</span>
   
    <span class="k">if</span> <span class="n">theta</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> 
        <span class="n">theta</span> <span class="o">=</span> <span class="n">rvs_theta</span><span class="p">(</span><span class="n">Nsamp</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">m1</span><span class="p">),</span><span class="n">a</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="mf">1.4</span><span class="p">)</span>
        <span class="n">rand_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">m1</span><span class="p">))</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">rand_theta</span>
    
    <span class="n">rho_true</span> <span class="o">=</span> <span class="n">rho_s</span><span class="o">*</span><span class="n">theta</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">Md</span><span class="o">/</span><span class="n">Md_s</span><span class="p">,</span><span class="mi">5</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">dL_s</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span><span class="o">/</span><span class="n">dL</span><span class="p">)</span>
    <span class="n">rho_det_squarred</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ncx2</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">numdet</span><span class="p">,</span><span class="n">rho_true</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">rho_true</span><span class="p">))</span>
    <span class="n">rho_det</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">rho_det_squarred</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">rho_true</span> <span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">rho_det</span></div>

<div class="viewcode-block" id="quick_data_preparation"><a class="viewcode-back" href="../../icarogw.html#icarogw.simulation.quick_data_preparation">[docs]</a><span class="k">def</span> <span class="nf">quick_data_preparation</span><span class="p">(</span><span class="n">m1_astro</span><span class="p">,</span><span class="n">m2_astro</span><span class="p">,</span><span class="n">zmerg_astro</span><span class="p">,</span><span class="n">numdet</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">rho_s</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">dL_s</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">Md_s</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span><span class="n">snrthr</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span><span class="n">fgw_cut</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">theta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">reweight</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Prepare the data that will be used as input in the function : PE_quick_generation_samples()</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    m1_astro : numpy array</span>
<span class="sd">        True distribution of m1 in source frame, flat in z</span>
<span class="sd">    m2_astro : numpy array</span>
<span class="sd">        True distribution of m2 in source frame, flat in z</span>
<span class="sd">    zmerg_astro :numpy array</span>
<span class="sd">        True distribution of the redshift merger, flat in z</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="n">reweight</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Reweight by \frac{dV_{c}}{dz}\frac{1}{1+z}</span>
        <span class="c1"># N.B : It is optionnal, only useful if all astro distributions have been generated flat in z</span>
        <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">dVc_dz_reweight</span><span class="p">(</span><span class="n">m1_astro</span><span class="p">,</span><span class="n">m2_astro</span><span class="p">,</span><span class="n">zmerg_astro</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">m1_astro</span><span class="p">,</span> <span class="n">m2_astro</span><span class="p">,</span> <span class="n">zmerg_astro</span>

    <span class="c1"># Compute associated : snr, Mc, q</span>
    <span class="n">rho</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">rho_obs</span> <span class="o">=</span> <span class="n">snr_samples</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">numdet</span><span class="o">=</span><span class="n">numdet</span><span class="p">,</span><span class="n">rho_s</span><span class="o">=</span><span class="n">rho_s</span><span class="p">,</span><span class="n">dL_s</span><span class="o">=</span><span class="n">dL_s</span><span class="p">,</span><span class="n">Md_s</span><span class="o">=</span><span class="n">Md_s</span><span class="p">,</span><span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">Md</span> <span class="o">=</span> <span class="n">chirp_mass_det</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">mass_ratio</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">)</span>
    
    <span class="c1"># Compute the detected values : Md_obs, q_obs, theta_obs</span>
    <span class="n">Md_obs</span><span class="p">,</span> <span class="n">q_obs</span><span class="p">,</span> <span class="n">theta_obs</span> <span class="o">=</span> <span class="n">noise</span><span class="p">(</span><span class="n">Md</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">rho_obs</span><span class="p">)</span>
    
    <span class="c1"># Cut on the SNR and frequency of the GWs in det frame </span>
    <span class="n">idx_cut</span> <span class="o">=</span> <span class="n">snr_and_freq_cut</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">rho_obs</span><span class="p">,</span><span class="n">snrthr</span><span class="o">=</span><span class="n">snrthr</span><span class="p">,</span><span class="n">fgw_cut</span><span class="o">=</span><span class="n">fgw_cut</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">idx_cut</span><span class="p">,</span><span class="n">rho_obs</span><span class="p">,</span><span class="n">q_obs</span><span class="p">,</span><span class="n">Md_obs</span><span class="p">,</span><span class="n">theta_obs</span></div>


<div class="viewcode-block" id="PE_quick_generation_samples"><a class="viewcode-back" href="../../icarogw.html#icarogw.simulation.PE_quick_generation_samples">[docs]</a><span class="k">def</span> <span class="nf">PE_quick_generation_samples</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">idx</span><span class="p">,</span><span class="n">rho_obs</span><span class="p">,</span><span class="n">q_obs</span><span class="p">,</span><span class="n">Md_obs</span><span class="p">,</span><span class="n">theta_obs</span><span class="p">,</span><span class="n">Ninj</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">Nsamp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">numdet</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">rho_s</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">dL_s</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">Md_s</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span><span class="n">Ngen</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e7</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generate PE given a list of noisy quantities </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    m1, m2 : numpy array</span>
<span class="sd">        Primary masses m1 and m2 in the source frame</span>
<span class="sd">    z : numpy array</span>
<span class="sd">        Redshift of the source, corresponding to the masses</span>
<span class="sd">    theta : numpy array</span>
<span class="sd">        Parameter in [0,1.4] defined as https://arxiv.org/pdf/1405.7016.pdf</span>
<span class="sd">    idx : numpy array</span>
<span class="sd">        Indices of each signals that passe the snr&amp;freq cut</span>
<span class="sd">    q_obs : numpy array</span>
<span class="sd">        Mass ratio observed</span>
<span class="sd">    Md_obs : numpy array</span>
<span class="sd">        Chirp mass in the detector frame observed</span>
<span class="sd">    theta_obs : numpy array</span>
<span class="sd">        Parameter in [0,1.4] observed</span>
<span class="sd">    Ninj : int</span>
<span class="sd">        Number of wanted signals </span>
<span class="sd">    Nsamp: int</span>
<span class="sd">        Number of wanted posterior samples per signals</span>
<span class="sd">    numdet : integer</span>
<span class="sd">        number of detectors in the network, for the detection</span>
<span class="sd">    _s parameters : float</span>
<span class="sd">        Parameters that assess the sensitivity of the detector network we have</span>
<span class="sd">    _obs parameters :</span>
<span class="sd">        Notation used to describe the parameters that are drawn from the true ones, </span>
<span class="sd">        according to the likelihood models of annex B : https://arxiv.org/pdf/2103.14663.pdf</span>

<span class="sd">    return</span>
<span class="sd">    ------</span>
<span class="sd">    dict1 : dictionnary</span>
<span class="sd">        Contains the PE samples for each event we generated and that are detected (i.e passes the snr&amp;freq cut)</span>
<span class="sd">    dict2 : dictionnary</span>
<span class="sd">        Contains the true value of each parameters for each event. (a.k.a the true astrophysical distribution)</span>
<span class="sd">    idx : numpy array</span>
<span class="sd">        indices of the events for wich we generate PE samples</span>

<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">Ninj</span><span class="p">)</span>
    <span class="n">dict1</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">dict2</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">_tqdm</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
        
        
        <span class="c1"># Draw trials solution for the masses and the distance : m1s, m2s dLs (uniformly)</span>
        <span class="n">uncmass</span><span class="o">=</span><span class="mf">1.1</span><span class="o">*</span><span class="mf">0.7</span><span class="o">/</span><span class="p">(</span><span class="n">rho_obs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="mf">8.</span><span class="p">)</span>
        <span class="n">m1s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([(</span><span class="mi">1</span><span class="o">-</span><span class="n">uncmass</span><span class="p">)</span><span class="o">*</span><span class="n">m1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mf">0.1</span><span class="p">]),</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">uncmass</span><span class="p">)</span><span class="o">*</span><span class="n">m1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span> <span class="n">Ngen</span><span class="p">)</span>
        <span class="n">m2s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([(</span><span class="mi">1</span><span class="o">-</span><span class="n">uncmass</span><span class="p">)</span><span class="o">*</span><span class="n">m2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mf">0.1</span><span class="p">]),</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">uncmass</span><span class="p">)</span><span class="o">*</span><span class="n">m2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span> <span class="n">Ngen</span><span class="p">)</span>
        <span class="n">swap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">m1s</span><span class="o">&lt;</span><span class="n">m2s</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">m1s</span><span class="p">[</span><span class="n">swap</span><span class="p">],</span><span class="n">m2s</span><span class="p">[</span><span class="n">swap</span><span class="p">]</span><span class="o">=</span><span class="n">m2s</span><span class="p">[</span><span class="n">swap</span><span class="p">],</span><span class="n">m1s</span><span class="p">[</span><span class="n">swap</span><span class="p">]</span>
        
        <span class="n">uncdL</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="mf">1.2</span><span class="o">/</span><span class="p">(</span><span class="n">rho_obs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="mf">8.</span><span class="p">)</span>
        <span class="n">dLs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([(</span><span class="mi">1</span><span class="o">-</span><span class="n">uncdL</span><span class="p">)</span><span class="o">*</span><span class="n">z_to_dl</span><span class="p">(</span><span class="n">z</span><span class="p">)[</span><span class="n">i</span><span class="p">],</span><span class="mf">1.</span><span class="p">]),(</span><span class="mi">1</span><span class="o">+</span><span class="n">uncdL</span><span class="p">)</span><span class="o">*</span><span class="n">z_to_dl</span><span class="p">(</span><span class="n">z</span><span class="p">)[</span><span class="n">i</span><span class="p">],</span><span class="n">size</span><span class="o">=</span><span class="n">Ngen</span><span class="p">)</span>
        <span class="n">zs</span> <span class="o">=</span> <span class="n">dl_to_z</span><span class="p">(</span><span class="n">dLs</span><span class="p">)</span>
              
        <span class="c1">#unctheta=15*4e-1/rho_obs[i]</span>
        <span class="n">thetas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.4</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">Ngen</span><span class="p">)</span>
        
        <span class="n">qs</span> <span class="o">=</span> <span class="n">mass_ratio</span><span class="p">(</span><span class="n">m1s</span><span class="p">,</span><span class="n">m2s</span><span class="p">)</span>
        <span class="n">Mds</span> <span class="o">=</span> <span class="n">chirp_mass_det</span><span class="p">(</span><span class="n">m1s</span><span class="p">,</span><span class="n">m2s</span><span class="p">,</span><span class="n">zs</span><span class="p">)</span>
        
        <span class="n">rhos</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span><span class="n">snr_samples</span><span class="p">(</span><span class="n">m1s</span><span class="p">,</span><span class="n">m2s</span><span class="p">,</span><span class="n">zs</span><span class="p">,</span><span class="n">numdet</span><span class="o">=</span><span class="n">numdet</span><span class="p">,</span><span class="n">rho_s</span><span class="o">=</span><span class="n">rho_s</span><span class="p">,</span><span class="n">dL_s</span><span class="o">=</span><span class="n">dL_s</span><span class="p">,</span><span class="n">Md_s</span><span class="o">=</span><span class="n">Md_s</span><span class="p">,</span><span class="n">theta</span><span class="o">=</span><span class="n">thetas</span><span class="p">)</span>

        <span class="c1">#Prior to get masses in det frame and dL^2</span>
        <span class="n">prior</span> <span class="o">=</span> <span class="p">(</span><span class="n">dLs</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">zs</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
        <span class="c1"># Total likelihood estimate</span>
        <span class="n">likelihood_tot</span><span class="o">=</span><span class="n">likelihood_evaluation</span><span class="p">(</span><span class="n">rhos</span><span class="p">,</span><span class="n">qs</span><span class="p">,</span><span class="n">Mds</span><span class="p">,</span><span class="n">thetas</span><span class="p">,</span><span class="n">rho_obs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">q_obs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">Md_obs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">theta_obs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">numdet</span><span class="o">=</span><span class="n">numdet</span><span class="p">)</span><span class="o">*</span><span class="n">prior</span>
        
        
        <span class="c1"># Importance sampling</span>
        <span class="n">proba</span> <span class="o">=</span> <span class="n">likelihood_tot</span><span class="o">/</span><span class="n">likelihood_tot</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">idx_resampling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">Ngen</span><span class="p">,</span><span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">Nsamp</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">proba</span><span class="p">)</span>
        
        <span class="n">dict1</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;m1s_samp&#39;</span><span class="p">:</span><span class="n">m1s</span><span class="p">[</span><span class="n">idx_resampling</span><span class="p">],</span><span class="s1">&#39;m2s_samp&#39;</span><span class="p">:</span><span class="n">m2s</span><span class="p">[</span><span class="n">idx_resampling</span><span class="p">],</span>
                         <span class="s1">&#39;zmerge_samples&#39;</span><span class="p">:</span><span class="n">zs</span><span class="p">[</span><span class="n">idx_resampling</span><span class="p">],</span><span class="s1">&#39;m1d_samples&#39;</span><span class="p">:</span><span class="n">m1s</span><span class="p">[</span><span class="n">idx_resampling</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">zs</span><span class="p">[</span><span class="n">idx_resampling</span><span class="p">]),</span>
                        <span class="s1">&#39;m2d_samples&#39;</span><span class="p">:</span><span class="n">m2s</span><span class="p">[</span><span class="n">idx_resampling</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">zs</span><span class="p">[</span><span class="n">idx_resampling</span><span class="p">]),</span><span class="s1">&#39;Md_samples&#39;</span><span class="p">:</span><span class="n">Mds</span><span class="p">[</span><span class="n">idx_resampling</span><span class="p">],</span>
                        <span class="s1">&#39;q_samples&#39;</span><span class="p">:</span><span class="n">qs</span><span class="p">[</span><span class="n">idx_resampling</span><span class="p">],</span><span class="s1">&#39;rho_samples&#39;</span><span class="p">:</span><span class="n">rhos</span><span class="p">[</span><span class="n">idx_resampling</span><span class="p">],</span><span class="s1">&#39;dL_samples&#39;</span><span class="p">:</span><span class="n">dLs</span><span class="p">[</span><span class="n">idx_resampling</span><span class="p">],</span>
                         <span class="s1">&#39;theta_samples&#39;</span><span class="p">:</span><span class="n">thetas</span><span class="p">[</span><span class="n">idx_resampling</span><span class="p">]}</span>
        
        <span class="n">dict2</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;m1s_samp&#39;</span><span class="p">:</span><span class="n">m1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39;m2s_samp&#39;</span><span class="p">:</span><span class="n">m2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="s1">&#39;zmerge_samples&#39;</span><span class="p">:</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39;m1d_samples&#39;</span><span class="p">:</span><span class="n">m1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                        <span class="s1">&#39;m2d_samples&#39;</span><span class="p">:</span><span class="n">m2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="s1">&#39;Md_samples&#39;</span><span class="p">:</span><span class="n">chirp_mass_det</span><span class="p">(</span><span class="n">m1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">m2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                        <span class="s1">&#39;q_samples&#39;</span><span class="p">:</span><span class="n">mass_ratio</span><span class="p">(</span><span class="n">m1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">m2</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="s1">&#39;dL_samples&#39;</span><span class="p">:</span><span class="n">z_to_dl</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="s1">&#39;theta_samples&#39;</span><span class="p">:</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span><span class="p">]}</span>
        
        
    <span class="k">return</span> <span class="n">dict1</span><span class="p">,</span> <span class="n">dict2</span><span class="p">,</span> <span class="n">idx</span></div>


<div class="viewcode-block" id="injection_set_generator"><a class="viewcode-back" href="../../icarogw.html#icarogw.simulation.injection_set_generator">[docs]</a><span class="k">def</span> <span class="nf">injection_set_generator</span><span class="p">(</span><span class="n">Ninj</span><span class="p">,</span><span class="n">Ntot</span><span class="p">,</span><span class="n">mass_model</span><span class="p">,</span><span class="n">dic_param</span><span class="p">,</span><span class="n">zmax</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span><span class="n">snrthr</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span><span class="n">fgw_cut</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">numdet</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">rho_s</span><span class="o">=</span><span class="mf">9.</span><span class="p">,</span><span class="n">dL_s</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">Md_s</span><span class="o">=</span><span class="mf">25.</span><span class="p">,</span><span class="n">theta</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function generate the injection set to be given to IcaroGW to estimate the </span>
<span class="sd">    selection effects. </span>
<span class="sd">    Only a list of true parameters and the prior associated to each p(m1d,m2d)*p(dL) have to be stored.</span>

<span class="sd">    Paramters :</span>
<span class="sd">    -----------</span>
<span class="sd">    Ninj : Integer</span>
<span class="sd">        Number of detected injections wanted</span>
<span class="sd">    Ntot : integer</span>
<span class="sd">        Trial number of injection before detection</span>
<span class="sd">    zmax : float</span>
<span class="sd">        Redshift max upto you want to generate samples of dL</span>
<span class="sd">    mass_model : str</span>
<span class="sd">        Mass model you want to use to generate samples of m1s and m2s</span>
<span class="sd">    dic_param : dict</span>
<span class="sd">        Dictionnary corresponding to the parameters you want to use in the mass model</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">true_param</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;m1s&#39;</span><span class="p">:[],</span><span class="s1">&#39;m2s&#39;</span><span class="p">:[],</span><span class="s1">&#39;z&#39;</span><span class="p">:[],</span><span class="s1">&#39;snr&#39;</span><span class="p">:[],</span><span class="s1">&#39;m1d&#39;</span><span class="p">:[],</span><span class="s1">&#39;m2d&#39;</span><span class="p">:[],</span><span class="s1">&#39;dL&#39;</span><span class="p">:[],</span><span class="s1">&#39;prior&#39;</span><span class="p">:[]}</span>
    <span class="n">Ndet_inj</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">Ndet_inj</span> <span class="o">&lt;</span> <span class="n">Ninj</span><span class="p">:</span>

        <span class="c1"># Generation of m1,m2 in source with a PL + peak</span>
        <span class="n">m1s_inj</span><span class="p">,</span> <span class="n">m2s_inj</span><span class="p">,</span> <span class="n">pdf_m</span> <span class="o">=</span> <span class="n">generate_mass_inj</span><span class="p">(</span><span class="n">Nsamp</span><span class="o">=</span><span class="n">Ntot</span><span class="p">,</span><span class="n">mass_model</span><span class="o">=</span><span class="n">mass_model</span><span class="p">,</span><span class="n">dic_param</span><span class="o">=</span><span class="n">dic_param</span><span class="p">)</span>

        <span class="c1"># Generation of dL with a PL ( \propto dL^2)</span>
        <span class="n">dL_inj</span><span class="p">,</span> <span class="n">pdf_dL</span> <span class="o">=</span> <span class="n">generate_dL_inj</span><span class="p">(</span><span class="n">Nsamp</span><span class="o">=</span><span class="n">Ntot</span><span class="p">,</span><span class="n">zmax</span><span class="o">=</span><span class="n">zmax</span><span class="p">)</span>

        <span class="c1"># Store the associated total prior in det frame</span>
        <span class="n">z_inj</span> <span class="o">=</span> <span class="n">dl_to_z</span><span class="p">(</span><span class="n">dL_inj</span><span class="p">)</span>
        <span class="n">jacobian</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">z_inj</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">prior_inj</span> <span class="o">=</span> <span class="n">pdf_m</span><span class="o">*</span><span class="n">pdf_dL</span><span class="o">*</span><span class="n">jacobian</span>

        <span class="c1"># Compute the associated quantites to derive the true SNR</span>
        <span class="n">snr_inj</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">snr_obs</span> <span class="o">=</span> <span class="n">snr_samples</span><span class="p">(</span><span class="n">m1s_inj</span><span class="p">,</span><span class="n">m2s_inj</span><span class="p">,</span><span class="n">z_inj</span><span class="p">,</span><span class="n">numdet</span><span class="o">=</span><span class="n">numdet</span><span class="p">,</span><span class="n">rho_s</span><span class="o">=</span><span class="n">rho_s</span><span class="p">,</span><span class="n">dL_s</span><span class="o">=</span><span class="n">dL_s</span><span class="p">,</span><span class="n">Md_s</span><span class="o">=</span><span class="n">Md_s</span><span class="p">,</span><span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>

        <span class="c1"># Cut on freq and SNR</span>
        <span class="n">idx_detected_inj</span> <span class="o">=</span> <span class="n">snr_and_freq_cut</span><span class="p">(</span><span class="n">m1s_inj</span><span class="p">,</span><span class="n">m2s_inj</span><span class="p">,</span><span class="n">z_inj</span><span class="p">,</span><span class="n">snr_obs</span><span class="p">,</span><span class="n">snrthr</span><span class="o">=</span><span class="n">snrthr</span><span class="p">,</span><span class="n">fgw_cut</span><span class="o">=</span><span class="n">fgw_cut</span><span class="p">)</span>

        <span class="n">m1d_inj</span> <span class="o">=</span> <span class="n">m1s_inj</span><span class="p">[</span><span class="n">idx_detected_inj</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">z_inj</span><span class="p">[</span><span class="n">idx_detected_inj</span><span class="p">])</span>
        <span class="n">m2d_inj</span> <span class="o">=</span> <span class="n">m2s_inj</span><span class="p">[</span><span class="n">idx_detected_inj</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">z_inj</span><span class="p">[</span><span class="n">idx_detected_inj</span><span class="p">])</span>

        <span class="n">Ndet</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_detected_inj</span><span class="p">)</span>
        <span class="n">Ndet_inj</span> <span class="o">=</span> <span class="n">Ndet_inj</span> <span class="o">+</span> <span class="n">Ndet</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">Ndet_inj</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">+</span><span class="mi">1</span>

        <span class="n">true_param</span><span class="p">[</span><span class="s1">&#39;m1s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m1s_inj</span><span class="p">[</span><span class="n">idx_detected_inj</span><span class="p">])</span>
        <span class="n">true_param</span><span class="p">[</span><span class="s1">&#39;m2s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m2s_inj</span><span class="p">[</span><span class="n">idx_detected_inj</span><span class="p">])</span>
        <span class="n">true_param</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z_inj</span><span class="p">[</span><span class="n">idx_detected_inj</span><span class="p">])</span>
        <span class="n">true_param</span><span class="p">[</span><span class="s1">&#39;snr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snr_inj</span><span class="p">[</span><span class="n">idx_detected_inj</span><span class="p">])</span>
        <span class="n">true_param</span><span class="p">[</span><span class="s1">&#39;m1d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m1d_inj</span><span class="p">)</span>
        <span class="n">true_param</span><span class="p">[</span><span class="s1">&#39;m2d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m2d_inj</span><span class="p">)</span>
        <span class="n">true_param</span><span class="p">[</span><span class="s1">&#39;dL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dL_inj</span><span class="p">[</span><span class="n">idx_detected_inj</span><span class="p">])</span>
        <span class="n">true_param</span><span class="p">[</span><span class="s1">&#39;prior&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prior_inj</span><span class="p">[</span><span class="n">idx_detected_inj</span><span class="p">])</span>

    <span class="c1"># Concatenate and downselect event to Ninj wanted</span>
    <span class="k">for</span> <span class="n">keys</span> <span class="ow">in</span> <span class="n">true_param</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">true_param</span><span class="p">[</span><span class="n">keys</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">true_param</span><span class="p">[</span><span class="n">keys</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">Ndet_inj</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">true_param</span><span class="p">[</span><span class="s1">&#39;m1s&#39;</span><span class="p">])</span>
    <span class="n">Ntot_gen</span> <span class="o">=</span> <span class="n">Ntot</span><span class="o">*</span><span class="n">c</span>

    <span class="k">return</span> <span class="n">true_param</span><span class="p">,</span> <span class="n">Ntot_gen</span><span class="p">,</span> <span class="n">Ndet_inj</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Simone Mastrogiovanni.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>